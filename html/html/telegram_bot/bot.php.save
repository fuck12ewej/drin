<?php

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
$host = '127.0.0.1';
$db   = 'telegram_bot'; // –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
$user = 'root';
$pass = 'root';
$charset = 'utf8mb4';

// Telegram Bot Token
$token = '8191621990:AAEc-g32Tz5e-GtrPj6kx3kZVWJh-o9l-ik';
$apiUrl = "https://api.telegram.org/bot$token/";

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
$dsn = "mysql:host=$host;dbname=$db;charset=$charset";
$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
];
try {
    $pdo = new PDO($dsn, $user, $pass, $options);
} catch (\PDOException $e) {
    die("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: " . $e->getMessage());
}


// –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Telegram
$update = json_decode(file_get_contents("php://input"), true);
$chatId = $update['message']['chat']['id'];
$text = $update['message']['text'];

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
if (strpos($text, '/add_profit') === 0) {
    addProfit($text, $chatId, $pdo);
} elseif ($text === '/topd') {
    sendTop($chatId, $pdo, "DAY", "—Å–µ–≥–æ–¥–Ω—è");
} elseif ($text === '/topm') {
    sendTop($chatId, $pdo, "MONTH", "—ç—Ç–æ—Ç –º–µ—Å—è—Ü");
} elseif ($text === '/topy') {
    sendTop($chatId, $pdo, "YEAR", "—ç—Ç–æ—Ç –≥–æ–¥");
} else {
    sendMessage($chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.");
}
// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏—Ç–∞
function addProfit($text, $chatId, $pdo) {
    $parts = explode(" ", $text);
    if (count($parts) < 3) {
        sendMessage($chatId, "–§–æ—Ä–º–∞—Ç: /add_profit –ò–º—è –°—É–º–º–∞");
        return;
    }

    $worker = $parts[1];
    $amount = (float)$parts[2];

    $stmt = $pdo->prepare("INSERT INTO profits (worker_name, amount) VALUES (?, ?)");
    $stmt->execute([$worker, $amount]);

    sendMessage($chatId, "‚úÖ –ü—Ä–æ—Ñ–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω:\n–†–∞–±–æ—Ç–Ω–∏–∫: $worker\n–°—É–º–º–∞: $amount");
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ø–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É
function sendTop($chatId, $pdo, $period, $periodText) {
    if ($period === "DAY") {
        $query = "SELECT worker_name, SUM(amount) AS total FROM profits WHERE DATE(profit_date) = CURDATE() GROUP BY worker_name ORDER BY total DESC";
    } elseif ($period === "MONTH") {
        $query = "SELECT worker_name, SUM(amount) AS total FROM profits WHERE MONTH(profit_date) = MONTH(CURDATE()) AND YEAR(profit_date) = YEAR(CURDATE()) GROUP BY worker_name ORDER BY total DESC";
    } elseif ($period === "YEAR") {
        $query = "SELECT worker_name, SUM(amount) AS total FROM profits WHERE YEAR(profit_date) = YEAR(CURDATE()) GROUP BY worker_name ORDER BY total DESC";
    } else {
        sendMessage($chatId, "–û—à–∏–±–∫–∞ –ø–µ—Ä–∏–æ–¥–∞.");
        return;
    }

    $stmt = $pdo->query($query);
    $results = $stmt->fetchAll();

    if (count($results) === 0) {
        sendMessage($chatId, "üîπ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ $periodText.");
        return;
    }

    $message = "üèÜ –¢–æ–ø —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –∑–∞ $periodText:\n";
    foreach ($results as $index => $row) {
        $message .= ($index + 1) . ". " . $row['worker_name'] . ": " . $row['total'] . "\n";
    }

    sendMessage($chatId, $message);
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
function sendMessage($chatId, $message) {
    global $apiUrl;

    $url = $apiUrl . "sendMessage";
    $postFields = [
        'chat_id' => $chatId,
        'text' => $message
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $postFields);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_exec($ch);
    curl_close($ch);
}
?>
